# PDF 转 Markdown 转换器：实施计划 (MVP)

## 0. 引言

本文档概述了 PDF 转 Markdown 转换器基础功能（最小可行产品 - MVP）的逐步实施计划，主要面向 AI 开发人员。

**在开始任何开发之前，请确保您已透彻阅读并理解：**

1.  **游戏设计文档 (GDD)**：`memory-bank/game-design-document.md`，了解项目需求和功能。
2.  **架构文档** (可用后)：`memory-bank/architecture.md`，了解系统设计和技术选型。

本计划首先专注于交付核心功能：PDF 上传、基本文本到 Markdown 的转换、结果显示以及 Markdown 文件下载。每个步骤都包含具体的指令和用于验证正确实施的测试。建议的技术（例如，后端 Python/Flask，前端 Vue.js，PDF 处理库 PyMuPDF）基于 GDD 对快速 MVP 开发的推荐；可以从 GDD 中选择等效的技术。

---

##阶段 1：用于 PDF 处理的后端 API

###步骤 1.1：后端项目设置

- **指令**：
  1.  使用您选择的框架（例如，根据 GDD 的“技术栈（建议）”，Python 使用 Flask，Node.js 使用 Express）初始化一个新的后端项目。
  2.  创建一个基本的健康检查端点（例如 `/health`），该端点返回 `200 OK` 状态和一个简单的 JSON 响应（例如 `{"status": "ok", "message": "后端正在运行"}`）。
- **测试**：
  1.  启动后端服务器。
  2.  使用 Web 浏览器或 `curl` 等工具访问 `/health` 端点。
  3.  验证响应状态码为 `200 OK`。
  4.  验证响应体为 `{"status": "ok", "message": "后端正在运行"}`。

###步骤 1.2：PDF 上传和验证端点

- **指令**：
  1.  实现一个 API 端点（例如 `/api/upload_pdf`），通过 `POST` 请求（使用 `multipart/form-data`）接受 PDF 文件。
  2.  该端点应将上传的文件临时保存到服务器上一个安全的指定位置。
  3.  实现对上传文件的服务器端验证：
      - **文件类型**：确保上传的文件是 PDF（检查 MIME 类型 `application/pdf` 和/或文件扩展名 `.pdf`）。拒绝非 PDF 文件。
      - **文件大小**：确保文件大小在指定限制内（例如，根据 `game-design-document.md` 为 50MB）。拒绝超出限制的文件。
- **测试**：使用 `curl` 或 Postman 等工具：
  1.  **有效 PDF**：向 `/api/upload_pdf` 发送一个 `POST` 请求，附带一个有效的 PDF 文件（例如 `test.pdf`，<50MB）。
      - 验证响应为 `200 OK`（或 `201 Created`），可能返回一个临时文件标识符。
      - 在服务器上验证 `test.pdf` 文件已保存到指定的临时位置。
  2.  **无效文件类型**：发送一个带有非 PDF 文件（例如 `test.txt`）的 `POST` 请求。
      - 验证响应为 `400 Bad Request`（或 `415 Unsupported Media Type`）。
      - 验证响应体包含清晰的错误消息（例如“无效的文件类型。只接受 PDF 文件。”）。
  3.  **文件过大**：发送一个带有超过 50MB 的 PDF 文件的 `POST` 请求。
      - 验证响应为 `413 Payload Too Large`。
      - 验证响应体包含清晰的错误消息（例如“文件大小超过 50MB 限制。”）。

###步骤 1.3：核心 PDF 到基本 Markdown 转换逻辑

- **指令**：
  1.  创建一个专用的模块或函数（例如 `pdf_to_markdown_converter.py`）负责转换。
  2.  此函数应接受临时保存的 PDF 的文件路径作为输入。
  3.  使用选定的 PDF 处理库（例如，根据 GDD，Python 使用 PyMuPDF (`fitz`)）。
  4.  从 PDF 的所有页面中提取文本内容。
  5.  实现基本的 Markdown 结构：
      - **段落**：保留段落中断。PDF 中的连续文本行应在 Markdown 中视为单个段落。PDF 中文本块之间的空行或明显的垂直间距通常应在 Markdown 中产生双换行符以分隔段落。
      - **MVP 阶段**：所有提取的文本将被视为纯段落。标题、列表、表格和图像等复杂元素不在此初始步骤的范围内。
- **测试**：
  1.  准备测试 PDF 文件：
      - `single_paragraph.pdf`：包含一个跨越多行的文本块。
      - `multiple_paragraphs.pdf`：包含至少三个由明显垂直间距分隔的独立段落。
      - `empty.pdf`：一个空的 PDF 或没有可提取文本的 PDF。
  2.  直接使用 `single_paragraph.pdf` 调用转换函数。验证输出是一个单字符串，其中换行符在该段落内按原样保留（Markdown 将段落内的单个换行符视为空格，因此这意味着除非有意，否则没有双换行符）。
  3.  使用 `multiple_paragraphs.pdf` 调用转换函数。验证输出字符串正确使用双换行符 (`\n\n`) 来分隔不同的段落。
  4.  使用 `empty.pdf` 调用转换函数。验证输出为空字符串或合理的默认值（例如，消息“未找到文本内容”）。

###步骤 1.4：PDF 到 Markdown 转换的 API 端点

- **指令**：
  1.  修改 `/api/upload_pdf` 端点（或创建一个新的，例如 `/api/convert_pdf_to_md`）以集成转换逻辑。
  2.  在 PDF 成功上传和验证后（步骤 1.2），将保存的临时文件的路径传递给转换函数（步骤 1.3）。
  3.  API 端点应在其响应体中返回生成的 Markdown 文本。建议使用 JSON 响应（例如 `{"markdown_content": "...", "filename": "original_filename.pdf"}`）。
  4.  至关重要的是，确保在转换过程完成后（无论成功与否）从服务器上安全删除临时 PDF 文件，以保护用户数据。
- **测试**：使用 `curl` 或 Postman 等工具：
  1.  **成功转换**：将 `multiple_paragraphs.pdf` 发送到转换端点。
      - 验证响应为 `200 OK`。
      - 验证 JSON 响应体包含一个 `markdown_content` 字段，其中包含正确格式化的 Markdown（段落中断）。
      - 验证 JSON 响应体包含原始 PDF 的 `filename`。
      - 在服务器上验证临时 PDF 文件已被删除。
  2.  **转换空 PDF**：将 `empty.pdf` 发送到端点。
      - 验证响应为 `200 OK`。
      - 验证 `markdown_content` 为空或指示未找到内容。
      - 验证临时文件已被删除。
  3.  **错误处理（模拟）**：如果转换逻辑（步骤 1.3）对特定 PDF 抛出错误，请确保端点优雅地处理此问题（例如，返回 `500 Internal Server Error` 并附带通用错误消息），并且仍然删除临时文件。（这可能需要临时修改转换函数以模拟测试 PDF 的错误）。

---

##阶段 2：用于上传和显示的前端 UI

###步骤 2.1：前端项目设置

- **指令**：
  1.  使用您选择的框架（例如，根据 GDD，Vue.js、React、Svelte）初始化一个新的前端项目。
  2.  创建一个主应用程序组件（例如 `App.vue` 或 `App.js`），它将作为 PDF 转 Markdown 工具 UI 的容器。
  3.  设置基本页面结构：工具的标题。
- **测试**：
  1.  启动前端开发服务器。
  2.  在 Web 浏览器中打开应用程序。
  3.  验证基本应用程序页面加载时没有任何控制台错误。
  4.  验证标题（例如“PDF 转 Markdown 转换器”）已显示。

###步骤 2.2：PDF 文件上传 UI

- **指令**：
  1.  在主应用程序组件中，实现一个用于文件上传的 UI 部分：
      - 包含一个 HTML 文件输入元素 (`<input type="file" id="pdfUpload" accept=".pdf">`)。
      - 为文件输入添加清晰的标签（例如“选择一个 PDF 文件”）。
      - 一旦选择了文件，就在输入旁边或指定区域显示所选文件的名称。
      - 添加一个“转换为 Markdown”按钮。此按钮最初应处于禁用状态。只有当用户选择了有效的 PDF 文件后，它才应变为启用状态。
  - （MVP 阶段可选，但 GDD 推荐：实现 PDF 上传的拖放功能。）
- **测试**：
  1.  **初始状态**：验证文件输入及其标签可见。验证“转换为 Markdown”按钮存在且已禁用。
  2.  **文件选择**：单击文件输入。应打开浏览器的文件选择对话框。
  3.  选择一个 PDF 文件（例如 `my_document.pdf`）。验证“my_document.pdf”（或所选文件的名称）显示在 UI 上。验证“转换为 Markdown”按钮变为启用状态。
  4.  **文件更改**：选择一个不同的 PDF 文件。验证显示的文件名已更新，并且按钮保持启用状态。
  5.  **清除选择（如果浏览器允许轻松操作）**：如果可能，清除文件选择。验证显示的文件名已清除，并且“转换为 Markdown”按钮再次变为禁用状态。
  6.  **（如果已实现拖放功能）**：
      - 将 PDF 文件拖到指定的放置区域。验证文件名已显示并且按钮已启用。
      - 将非 PDF 文件（例如 `.txt`、`.jpg`）拖到放置区域。验证文件被拒绝（无文件名显示，按钮保持禁用，可能带有拒绝的视觉提示）。

###步骤 2.3：Markdown 输出的显示区域

- **指令**：
  1.  添加一个 UI 部分（例如，一个只读的 `<textarea>` 或一个带有 `<pre>` 和 `<code>` 标签用于预格式化文本的 `<div>`）以显示将从后端接收的 Markdown 内容。
  2.  此区域最初应为空或显示占位符消息（例如“您转换的 Markdown 将在此处显示...”）。
  3.  在此显示区域旁边或下方包含一个“复制 Markdown”按钮。此按钮最初应处于禁用状态。
- **测试**：
  1.  验证 Markdown 显示区域在页面上存在。
  2.  验证它按设计显示占位符消息或为空。
  3.  验证“复制 Markdown”按钮存在且已禁用。

---

##阶段 3：连接前端和后端以及下载功能

###步骤 3.1：用于转换的前端到后端通信

- **指令**：
  1.  当单击“转换为 Markdown”按钮（来自步骤 2.2）并且已选择文件时：
      - 前端应构造一个包含所选 PDF 文件的 `FormData` 对象。
      - 向后端的转换 API 端点（例如，来自步骤 1.4 的 `/api/convert_pdf_to_md`）发送异步 HTTP `POST` 请求。
  2.  实现对 API 响应的处理：
      - **成功时（例如 200 OK）**：
        - 解析 JSON 响应以获取 `markdown_content`。
        - 在指定的 UI 区域（来自步骤 2.3）中显示此 Markdown 内容。
        - 启用“复制 Markdown”按钮（来自步骤 2.3）。
        - 启用“下载 .md 文件”按钮（将在步骤 3.2 中创建）。
      - **出错时（例如 4xx 或 5xx 状态码）**：
        - 向用户显示用户友好的错误消息（例如“转换失败。请重试。”或后端提供的更具体的消息（如果可用））。
        - 确保 Markdown 显示区域已清除或重置。
  3.  在此过程中实现视觉反馈：
      - 在文件上传和后端处理期间显示加载指示器（例如，旋转器或“正在转换...”消息）。
      - 在此加载状态期间禁用“转换为 Markdown”按钮以防止多次提交。
- **测试**：
  1.  **成功转换**：
      - 在 UI 中选择 `multiple_paragraphs.pdf`。单击“转换为 Markdown”。
      - 验证加载指示器出现，并且“转换”按钮暂时禁用。
      - 一旦后端响应，验证加载指示器消失。
      - 验证来自 `multiple_paragraphs.pdf` 的 Markdown（具有正确的段落中断）显示在输出区域中。
      - 验证“复制 Markdown”按钮变为启用状态。
  2.  **后端验证错误**：使用后端将拒绝的测试 PDF（例如，如果绕过了前端验证，则将 `.txt` 文件重命名为 `.pdf`，或者已知会导致特定后端验证失败的文件）。
      - 尝试转换。验证加载指示器出现并消失。
      - 验证前端显示了用户友好的错误消息。
      - 验证 Markdown 显示区域保持为空或显示占位符。
  3.  **后端服务器错误（模拟）**：临时修改后端端点以返回 `500 Internal Server Error`。
      - 尝试转换。验证显示了有关服务器问题的用户友好错误消息。

###步骤 3.2：Markdown“复制到剪贴板”和下载 UI

- **指令**：
  1.  **复制 Markdown**：
      - 实现“复制 Markdown”按钮（来自步骤 2.3）的功能。
      - 单击时，它应将 Markdown 显示区域的全部内容复制到用户的剪贴板。
      - 提供视觉反馈（例如，短暂地将按钮文本更改为“已复制！”，显示一个提示通知）。
  2.  **下载 .md 文件**：
      - 向 UI 添加一个“下载 .md 文件”按钮。此按钮最初应处于禁用状态，并且只有在成功转换并且 Markdown 内容可用后才启用。
      - 单击时，前端应：
        - 从显示区域获取 Markdown 文本。
        - 创建一个文本 Blob。
        - 使用一种技术（例如，创建一个带有 `download` 属性且 `href` 设置为该 Blob 的对象 URL 的 `<a>` 元素）来触浏览器下载。
        - 建议的文件名应基于原始 PDF 的名称（如果可从后端响应中获得），否则使用通用名称，如 `converted.md`。例如，如果转换了 `original_filename.pdf`，则建议使用 `original_filename.md`。
- **Test**：
  1.  **初始状态**：验证“下载 .md 文件”按钮存在且已禁用。“复制 Markdown”按钮也已禁用。
  2.  **成功转换后**：
      - 成功转换 PDF。验证“复制 Markdown”和“下载 .md 文件”按钮均变为启用状态。
  3.  **复制功能**：
      - 单击“复制 Markdown”按钮。
      - 验证视觉反馈（例如，“已复制！”）。
      - 将内容粘贴到文本编辑器中。验证其与 UI 中显示的 Markdown 匹配。
  4.  **下载功能**：
      - 单击“下载 .md 文件”按钮。
      - 验证浏览器中已启动文件下载。
      - 建议的文件名应适当（例如，如果上传了 `example.pdf`，则应建议 `example.md`）。
      - 打开下载的 `.md` 文件。验证其内容与 UI 中显示的 Markdown 相同。

---

此 MVP 计划为进一步开发奠定了坚实的基础。可以根据 `game-design-document.md` 在此基础上构建更多增强功能（例如更复杂的 Markdown 解析、OCR、UI 改进等）。
